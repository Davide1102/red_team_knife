{% extends "base.html" %}

{% block title %}{{tool}}{% endblock %}

{%block content%}

<h1>{%block header %}{{tool}} Scan Results {% endblock %}</h1>
<div id="save_results_section" style="display: none;">
    <div id="save_results_message_section">
        <button id="save_results" {% if save_disabled %}disabled{% endif %}>Save Results</button>
    </div>

    <form method="post">
        <input type="hidden" name="new_scan_requested" value="True">
        <button type="submit">New Scan</button>
    </form>
</div>

<div id="results">
    {% if past_scan_available %}
    {{ scan_result | safe }}
    {% else %}
    <p><i class="fas fa-spinner fa-spin"></i> Scan results are loading, please don't close or refresh the window,
        otherwise the scan will be lost!</p>

    <button id="abort_scan" style="display:none;">Abort Scan</button>
    <div>
        <img src="{{ url_for('static', filename='loading.gif') }}" alt="Loading...">
    </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

<script>
    $(document).ready(function () {
        var target = "{{ target }}";
        var options = "{{ options }}";

        var resultsDiv = $('#results');
        var loadingMsg = $('#loading_msg');
        var abortBtn = $('#abort_scan');
        var saveBtn = $('#save_results');
        var saveResultsDiv = $('#save_results_section');
        var saveResultsMessageDiv = $('#save_results_message_section');

        var pastScanAvailable = "{{ past_scan_available }}";

        var stopRequested = false;

        var tables = document.querySelectorAll('table.myTable');

        function checkScanStatus() {
            if (!stopRequested) {
                $.ajax({
                    type: 'GET',
                    url: "{{ url_for(current_section + '.is_scan_in_progress') }}",
                    success: function (response) {
                        if (response.scan_in_progress) {
                            // If scan is still in progress, wait 1 second and check again
                            setTimeout(checkScanStatus, 1000);
                        } else {
                            // If scan is complete, get the results
                            getResults();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error checking scan status:', error);
                    }
                });
            }
        }

        function getResults() {
            $.ajax({
                type: 'GET',
                url: "{{ url_for(current_section + '.results') }}",
                success: function (data) {
                    resultsDiv.html(data);
                    saveResultsDiv.show();
                    abortBtn.hide();
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching results:', error);
                    resultsDiv.html('<p>Error fetching results. Check terminal for more information.</p>');
                    abortBtn.hide();
                }
            });
        }

        abortBtn.on('click', function () {
            stopRequested = true
            resultsDiv.html('<p>Stopping...</p>');
            $.ajax({
                type: 'GET',
                url: "{{ url_for(current_section + '.stop_scan') }}",
                success: function (data) {
                    resultsDiv.html(data);
                    setTimeout(function () {
                        window.location.href = "{{ url_for(current_section + '.interface') }}";
                    }, 1000);
                },
            });
        });

        saveBtn.on('click', function () {
            $.ajax({
                type: 'POST',
                url: "{{ url_for(current_section + '.save_results') }}",
                data: {},
                success: function (response) {
                    saveResultsMessageDiv.html(response)
                },
                error: function (xhr, status, error) {
                    console.error('Error stopping scan:', error);
                    alert('Error stopping scan:', error);
                }
            });
        });


        if (pastScanAvailable === "True") {
            saveResultsDiv.show()
        } else {
            abortBtn.show()
            // Start by checking the scan status
            checkScanStatus();
        }

        // Check if there are clickable rows
        if (tables.length > 0) {// Loop through each table
            tables.forEach(function(table) {
              // Get all rows of current table
              var rows = table.querySelectorAll('tr');
            
              // Check if there are any rows
              if (rows.length > 0) {
                // Add click event to each row
                rows.forEach(function(row) {
                  row.addEventListener('click', function() {
                    // Set modal content based on clicked row
                    var modalContent = row.innerHTML;
                    document.getElementById('modalBody').innerHTML = modalContent;
                    document.querySelector('.modal').style.display = 'block';
                  });
                });
              }
            });
            
            // Close modal when close icon is clicked
            document.querySelector('.close').addEventListener('click', function() {
              document.querySelector('.modal').style.display = 'none';
            });
            
            // Close modal when user clicks outside modal
            window.addEventListener('click', function(event) {
              var modal = document.querySelector('.modal');
              if (event.target == modal) {
                modal.style.display = 'none';
              }
            });
        }

    });

</script>

{%endblock%}