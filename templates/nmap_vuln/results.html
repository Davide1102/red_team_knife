{% extends 'results_base.html' %}

{% block extra_script %}
<div class="modal">
    <!-- Modal Content -->
    <div class="modal-content">
        <span class="close">&times;</span>
        <p id="modalBody"></p>
    </div>
</div>

<script>
    function afterResultsScript() {
        function checkUrlStatus() {
            $.ajax({
                type: 'GET',
                url: "{{ url_for('searchsploit.is_scan_in_progress') }}",
                success: function (response) {
                    if (response.scan_in_progress) {
                        // If scan is still in progress, wait 1 second and check again
                        setTimeout(checkUrlStatus, 1000);
                    } else {
                        // If scan is complete, get the results
                        getUrl();
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error checking scan status:', error);
                }
            });
        }

        function getUrl() {
            $.ajax({
                type: 'GET',
                url: "{{ url_for('searchsploit.results') }}",
                success: function (data) {
                    // Update the modal body with the fetched data
                    $('#modalBody').html(data);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching results:', error);
                    // Update the modal body with an error message
                    $('#modalBody').html('<p>Error fetching results. Check terminal for more information.</p>');
                }
            });
        }

        // Add click event to each row
        $('table.vuln_table').on('click', 'tr.exploit-available', function () {
            // Display modal with loading indicator
            $('#modalBody').html('<div class="loader">Loading...</div>');
            $('.modal').css('display', 'block');

            // Get the content of the last cell of the clicked row
            var vulnerabilityCode = $(this).find('.vuln-code').text().trim();
            // Make AJAX request to /searchsploit using jQuery
            $.ajax({
                url: '/searchsploit',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ target: vulnerabilityCode }),
                success: function (response) {
                    // Update the modal body with the fetched data
                    $('#modalBody').html(response);
                    // Check the status after updating modal body
                    checkUrlStatus();
                },
                error: function () {
                    console.error('Error: Unable to fetch vulnerability reference.');
                    // Update the modal body with an error message
                    $('#modalBody').html('Error: Unable to fetch vulnerability reference.');
                }
            });
        });

        // Close modal when close icon is clicked
        $('.close').on('click', function () {
            $('.modal').css('display', 'none');
        });

        // Close modal when user clicks outside modal
        $(window).on('click', function (event) {
            var modal = $('.modal');
            if ($(event.target).is(modal)) {
                modal.css('display', 'none');
            }
        });
    }
</script>



{% endblock %}