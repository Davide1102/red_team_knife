{% extends "results_base.html" %}

{% block header %} Nmap Scan Results {%endblock%}

{% block ajax_script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

<script>
    $(document).ready(function () {
        var target = "{{ target }}";
        var options = "{{ options }}";
        var nmapResultsDiv = $('#results');
        var loadingMsg = $('#loading_msg');
        var abortBtn = $('#abort_scan');
        var saveBtn = $('#save_results');
        var saveResultsDiv = $('#save_results_section');
        var pastScanAvailable = "{{ past_scan_available }}"
        var xhr;

        abortBtn.on('click', function () {
            if (xhr && xhr.readyState !== 4) {
                xhr.abort();
                window.location.href = "{{url_for('nmap.interface')}}"
            }
        });

        saveBtn.on('click', function () {
            $.ajax({
                type: 'POST',
                url: "{{url_for('nmap.save_results')}}",
                data: {},
                success: function (response) {

                    saveResultsDiv.html(response)
                },
                error: function (xhr, status, error) {

                    console.error('Error saving results:', error);
                    alert('Error saving results.');
                }
            });
        });

        if (pastScanAvailable === "False") {
            xhr = $.ajax({
                type: 'POST',
                url: "{{url_for('nmap.results')}}",
                data: { target: target, options: options },
                beforeSend: function () {
                    loadingMsg.html('<i class="fa fa-spinner fa-spin"></i> Loading...');
                    abortBtn.show();
                },
                success: function (data) {
                    nmapResultsDiv.html(data);
                    saveBtn.show();
                    abortBtn.hide();
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching Nmap results:', error);
                    nmapResultsDiv.html('<p>Error fetching Nmap results. Check terminal for more information.</p>');
                    abortBtn.hide();
                }
            });
        } else {

        }
    });

</script>
{%endblock%}